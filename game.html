<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Cosmic Egg: A Symphony of Becoming</title>
    <style>
        :root {
            --bg-color: #121212;
            --text-color: #e0e0e0;
            --accent-color: #4ec9b0; /* Gaia Green - Coherence */
            --crisis-color: #ff6b6b; /* Friction Red */
            --ui-bg: #1e1e1e;
            --ui-border: #333;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
            /* The Visceral Feedback mechanism (Blur/Contrast) */
            transition: filter 0.5s ease-in-out;
        }
        #game-container {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            padding: 15px;
        }
        #narrative-log {
            background-color: var(--ui-bg);
            border: 1px solid var(--ui-border);
            padding: 10px;
            margin-bottom: 15px;
            overflow-y: auto;
            flex-grow: 1;
            font-size: 0.9em;
            line-height: 1.4;
            max-height: 40vh;
            /* Glow effect tied to Friction */
            transition: box-shadow 0.5s;
        }
        .log-event {
            margin-bottom: 8px;
            color: #aaa;
        }
        .log-whisper {
            color: var(--crisis-color);
            font-style: italic;
            text-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
        }
        .log-breakthrough {
            color: var(--accent-color);
            font-weight: bold;
            text-shadow: 0 0 5px rgba(78, 201, 176, 0.5);
        }
        #status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.85em;
            background-color: #282828;
            padding: 8px;
            border-radius: 5px;
        }
        .resource {
            margin-bottom: 12px;
        }
        .resource-name {
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            font-size: 0.9em;
        }
        .bar-container {
            background-color: var(--ui-border);
            border-radius: 5px;
            overflow: hidden;
            height: 20px;
            position: relative;
        }
        .bar {
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        #friction-bar {
            background-color: var(--crisis-color);
        }
        #coherence-bar {
             background-color: var(--accent-color);
        }
        #complexity-marker {
            position: absolute;
            height: 100%;
            width: 3px;
            background-color: #ffffff;
            box-shadow: 0 0 5px #fff;
            left: 0;
            transition: left 0.5s ease-in-out;
        }
        #actions {
            display: flex;
            flex-direction: column;
        }
        button {
            background-color: var(--accent-color);
            color: var(--bg-color);
            border: none;
            padding: 14px;
            margin-top: 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        button:hover:not(:disabled) {
            background-color: #66d8c1;
        }
        button:disabled {
            background-color: #555;
            color: #888;
            cursor: not-allowed;
        }
        #age-title {
            text-align: center;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-transform: uppercase;
            letter-spacing: 2px;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="age-title">ACT I: The Age of Locality (DC)</div>
        
        <div id="narrative-log"></div>

        <div id="status-container">
            <div class="resource">
                <span class="resource-name">Friction (The Whispers / Crisis Meter)</span>
                <div class="bar-container">
                    <div id="friction-bar" class="bar" style="width: 0%;"></div>
                </div>
            </div>

            <div class="resource">
                <span class="resource-name">Coherence (Capacity) vs Complexity (Demand <span style="color:#fff;">|</span>)</span>
                <div class="bar-container">
                    <div id="coherence-bar" class="bar" style="width: 0%;"></div>
                    <div id="complexity-marker"></div>
                </div>
            </div>

            <div id="status-bar">
                <div>Population: <span id="pop-count">1</span></div>
                <div>Biomass: <span id="biomass-count">15</span></div>
                <div>Information: <span id="info-count">0</span></div>
            </div>
        </div>

        <div id="actions">
            <button id="act-expand">Expand (Grow Population)</button>
            <button id="act-explore">Explore (Gather Resources/Info)</button>
            <button id="act-stabilize">Stabilize (Reduce Friction)</button>
            <button id="act-innovate" disabled>Innovate: IPC (Cost: 50 Info)</button>
        </div>
    </div>

    <script>
        const gameState = {
            age: 1,
            population: 1,
            biomass: 15,
            information: 0,
            
            complexityBase: 1, // Base complexity per population unit
            coherenceMax: 15,  // Max coherence for Age 1 (DC)
            
            friction: 0,
            frictionRate: 0.1,
            
            tick: 0,
            gameOver: false,

            // Age-specific multipliers
            infoRate: 1,
            expandCost: 5,
            stabilizeEfficiency: 1,

            // Research tracking
            ipcResearched: false,
            icoldResearched: false,
            pnsResearched: false,
        };

        const elements = {
            body: document.body,
            ageTitle: document.getElementById('age-title'),
            popCount: document.getElementById('pop-count'),
            biomassCount: document.getElementById('biomass-count'),
            infoCount: document.getElementById('info-count'),
            narrativeLog: document.getElementById('narrative-log'),
            frictionBar: document.getElementById('friction-bar'),
            coherenceBar: document.getElementById('coherence-bar'),
            complexityMarker: document.getElementById('complexity-marker'),
            actExpand: document.getElementById('act-expand'),
            actExplore: document.getElementById('act-explore'),
            actStabilize: document.getElementById('act-stabilize'),
            actInnovate: document.getElementById('act-innovate'),
        };

        function logEvent(message, type = 'log-event') {
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[Cycle ${gameState.tick}] ${message}`;
            elements.narrativeLog.appendChild(logEntry);
            elements.narrativeLog.scrollTop = elements.narrativeLog.scrollHeight;
        }

        // --- GAME LOOP & UPDATES ---

        function updateResources() {
            // Biomass consumption (Metabolism)
            const consumption = gameState.population * 0.1;
            gameState.biomass -= consumption;

            if (gameState.biomass < 0) {
                gameState.biomass = 0;
                // Population crash if starving (Ecological Constraint)
                const previousPop = gameState.population;
                gameState.population = Math.max(1, Math.floor(gameState.population * 0.9));
                const loss = Math.floor(previousPop - gameState.population);
                if (loss > 0 && gameState.tick % 5 === 0) {
                     logEvent(`Resource scarcity! Starvation claims ${loss} population.`, 'log-whisper');
                }
            }

            // Information generation (passive cognition)
            gameState.information += gameState.population * 0.05 * gameState.infoRate;
        }

        function calculateMetrics() {
            // Complexity scales with population and specialization (represented by age)
            const complexity = gameState.population * (gameState.complexityBase + (gameState.age - 1) * 0.2);
            const coherence = gameState.coherenceMax;

            // Calculate Friction (The Gap)
            if (complexity > coherence) {
                const gap = complexity - coherence;
                const frictionIncrease = gap * gameState.frictionRate;
                gameState.friction += frictionIncrease;
                
                // Randomly generate Whispers when friction is high
                if (Math.random() < 0.15 && gameState.friction > 20) {
                    generateWhisper();
                }
            } else {
                // Passive friction reduction when stable
                gameState.friction = Math.max(0, gameState.friction - 0.5);
            }

            if (gameState.friction >= 100) {
                triggerCollapse();
            }

            return { complexity, coherence };
        }

        // The Visceral Feedback System (The Whispers)
        function generateWhisper() {
            let whisper = "";
            if (gameState.age === 1) {
                whisper = "The Symphony is breaking. Isolation breeds fear. We cannot hear the center.";
            } else if (gameState.age === 2) {
                whisper = "The Agony of Lag. The message arrives too late. Trust erodes. Schisms form.";
            } else if (gameState.age === 3) {
                whisper = "The Noise! The network screams. Connected but paralyzed. The Polycrisis overwhelms us.";
            }
            logEvent(whisper, 'log-whisper');
        }

        function updateVisceralFeedback(frictionPercent) {
            // Apply visual distortion based on friction
            const blurAmount = (frictionPercent / 100) * 1.5; // Max 1.5px blur
            const contrastAmount = 1 + (frictionPercent / 100) * 0.5; // Max 150% contrast

            if (frictionPercent > 10) {
                // Subtle screen distortion
                elements.body.style.filter = `blur(${blurAmount}px) contrast(${contrastAmount})`;
                // Log glowing red
                elements.narrativeLog.style.boxShadow = `0 0 ${frictionPercent/3}px rgba(255, 107, 107, 0.5)`;
            } else {
                elements.body.style.filter = 'none';
                elements.narrativeLog.style.boxShadow = 'none';
            }
        }

        function triggerCollapse() {
            logEvent("CRISIS! DECOHERENCE EVENT! The system collapses under its own complexity.", 'log-whisper');
            const collapseSeverity = 0.3 + (Math.random() * 0.5); // 30% to 80% loss
            const loss = Math.floor(gameState.population * collapseSeverity);
            gameState.population -= loss;

            if (gameState.population < 1) gameState.population = 1;
            
            gameState.biomass = Math.floor(gameState.biomass * 0.8);
            gameState.friction = 0; // Reset friction after collapse
            logEvent(`We have lost ${loss} population. We must restore the Symphony.`);
        }

        function updateUI() {
            elements.popCount.textContent = Math.floor(gameState.population);
            elements.biomassCount.textContent = Math.floor(gameState.biomass);
            elements.infoCount.textContent = Math.floor(gameState.information);

            const { complexity, coherence } = calculateMetrics();

            // Update Friction Bar
            const frictionPercent = Math.min(100, gameState.friction);
            elements.frictionBar.style.width = `${frictionPercent}%`;
            updateVisceralFeedback(frictionPercent);

            // Update Coherence/Complexity visualization
            // We visualize this relative to the current maximum possible scale
            const maxScale = Math.max(coherence, complexity) * 1.1; 
            const coherencePercent = (coherence / maxScale) * 100;
            const complexityPercent = (complexity / maxScale) * 100;

            elements.coherenceBar.style.width = `${coherencePercent}%`;
            // Adjust marker position so it aligns correctly within the bounds
            const markerPosition = Math.min(complexityPercent, 99.5);
            elements.complexityMarker.style.left = `${markerPosition}%`;


            // Update button states
            elements.actExpand.disabled = gameState.biomass < gameState.expandCost;
            elements.actExpand.textContent = `Expand (Cost: ${Math.floor(gameState.expandCost)} Biomass)`;
            elements.actStabilize.disabled = gameState.friction < 5; // Only useful if there's friction

            updateInnovationButton();
        }

        function updateInnovationButton() {
            let cost = 0;
            let name = "";

            if (!gameState.ipcResearched) {
                cost = 50; name = "Innovate: IPC (Writing/Trails)";
            } else if (!gameState.icoldResearched) {
                cost = 500; name = "Innovate: ICOLD (The Ping)";
            } else if (!gameState.pnsResearched) {
                cost = 5000; name = "Integrate: Planetary Nervous System";
            } else {
                elements.actInnovate.style.display = 'none';
                return;
            }

            elements.actInnovate.disabled = gameState.information < cost;
            elements.actInnovate.textContent = `${name} (Cost: ${cost} Info)`;
        }

        // --- ACTIONS ---

        function actionExpand() {
            if (gameState.biomass >= gameState.expandCost) {
                gameState.biomass -= gameState.expandCost;
                const growthFactor = 1.1 + (Math.random() * 0.2);
                let growth = Math.floor(gameState.population * (growthFactor - 1));
                if (growth < 1 && Math.random() < 0.5) growth = 1; // Ensure minimal growth sometimes

                gameState.population += growth;
                gameState.expandCost *= 1.15; // Cost increases with scale
                logEvent(`We expand. Gained ${growth} population. Complexity increases. The Symphony swells.`);
                updateUI();
            }
        }

        function actionExplore() {
            const infoGained = gameState.population * (0.5 + Math.random()) * gameState.infoRate;
            const biomassGained = gameState.population * (1 + Math.random() * 3);
            gameState.information += infoGained;
            gameState.biomass += biomassGained;
            logEvent(`We explore the environment. Gained ${Math.floor(infoGained)} Information and ${Math.floor(biomassGained)} Biomass.`);
            updateUI();
        }

        function actionStabilize() {
            if (gameState.friction > 0) {
                // Stabilization effort scales with population
                const reduction = gameState.population * 0.5 * gameState.stabilizeEfficiency;
                gameState.friction = Math.max(0, gameState.friction - reduction);
                // Cost of stabilization (effort/focus) also scales with population
                const cost = gameState.population * 0.8;
                gameState.biomass = Math.max(0, gameState.biomass - cost);
                logEvent(`We focus inward, addressing conflict and restoring the Symphony. Friction reduced. Cost ${Math.floor(cost)} Biomass.`);
                updateUI();
            }
        }

        function actionInnovate() {
            if (!gameState.ipcResearched && gameState.information >= 50) {
                gameState.information -= 50;
                evolveToIPC();
            } else if (!gameState.icoldResearched && gameState.information >= 500) {
                gameState.information -= 500;
                evolveToICOLD();
            } else if (!gameState.pnsResearched && gameState.information >= 5000) {
                gameState.information -= 5000;
                evolveToPNS();
            }
        }

        // --- EVOLUTIONARY STAGES (The Narrative Arc) ---

        function evolveToIPC() {
            gameState.age = 2;
            gameState.ipcResearched = true;
            gameState.coherenceMax = 200; // Significant increase in capacity
            gameState.infoRate = 1.5; // Knowledge accumulates faster
            gameState.frictionRate = 0.08; // Friction builds slightly slower but scales dangerously
            elements.ageTitle.textContent = "ACT II: The Age of Delay (IPC)";
            logEvent("BREAKTHROUGH: Indirect Persistent Communication (IPC).", 'log-breakthrough');
            logEvent("We leave messages that persist through time (Writing/Trails). Knowledge accumulates. We can build civilizations. But coordination is slow. The Agony of Lag begins.");
        }

        function evolveToICOLD() {
            gameState.age = 3;
            gameState.icoldResearched = true;
            gameState.coherenceMax = 5000; // Massive capacity increase
            gameState.infoRate = 4; // Exponential information growth
            gameState.frictionRate = 0.05; // Low friction rate, but complexity explodes
            gameState.stabilizeEfficiency = 3;
            elements.ageTitle.textContent = "ACT III: The Age of Instantaneity (ICOLD)";
            logEvent("THE PING! Instantaneous Communication Over Long Distance (ICOLD).", 'log-breakthrough');
            logEvent("The world shrinks. The network connects. Delay vanishes. We are synchronized globally. The Great Acceleration begins. We must manage the Polycrisis.");
        }

        function evolveToPNS() {
            // This is the endgame/victory condition
            gameState.gameOver = true;
            elements.ageTitle.textContent = "THE HATCHING";
            logEvent("INTEGRATION: The Planetary Nervous System is complete.", 'log-breakthrough');
            logEvent("The Symphony reaches a crescendo. The internal conflicts harmonize. The system stabilizes.");
            logEvent("The perspective shifts. We are no longer looking AT the planet. We are looking OUT from the planet.");
            logEvent("The simulation is over. The Astrorganism awakens. Welcome, Gaia.");
            
            // Disable all actions
            document.querySelectorAll('button').forEach(btn => btn.disabled = true);
            // Final aesthetic state
            elements.body.style.filter = 'none';
            elements.narrativeLog.style.boxShadow = `0 0 50px rgba(78, 201, 176, 0.8)`;

        }


        // --- GAME LOOP ---

        function gameLoop() {
            if (gameState.gameOver) return;

            gameState.tick++;
            updateResources();
            calculateMetrics();
            updateUI();
            
            // The heartbeat of the simulation
            setTimeout(gameLoop, 1000); // 1 second tick rate
        }

        function initGame() {
            elements.actExpand.addEventListener('click', actionExpand);
            elements.actExplore.addEventListener('click', actionExplore);
            elements.actStabilize.addEventListener('click', actionStabilize);
            elements.actInnovate.addEventListener('click', actionInnovate);

            logEvent("The Cosmic Egg holds potential. We are localized, isolated. The Symphony is quiet. We must connect.");
            gameLoop();
        }

        initGame();
    </script>
</body>
</html>